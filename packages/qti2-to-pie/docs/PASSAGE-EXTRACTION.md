# Passage Extraction (QTI → PIE)

## Overview

The qti2-to-pie transformer now correctly extracts external passage references from QTI items and populates the PIE `passage` property. This enables proper round-trip transformation when working with external passages generated by pie-to-qti2.

## How It Works

### External Passages (Object References)

When QTI contains an `<object>` tag referencing an external passage file:

```xml
<object data="passages/passage-abc.xml"
        type="text/html"
        data-pie-passage-id="passage-abc">
  <p>Passage content not available</p>
</object>
```

The transformer:
1. Extracts the passage ID from `data-pie-passage-id` attribute
2. Populates the PIE item's `passage` property with this ID
3. Creates a placeholder passage model in `config.models[]`
4. Removes the `<object>` tag from the itemBody

**Result:**
```typescript
{
  id: 'item-123',
  passage: 'passage-abc', // ← External passage reference
  config: {
    models: [
      {
        id: 'passage-...',
        element: '@pie-element/passage',
        passages: [{ text: '[External passage: passages/passage-abc.xml]' }]
      },
      { /* question model */ }
    ]
  }
}
```

### Inline Passages (Stimulus Tags)

When QTI contains inline `<stimulus>` content:

```xml
<itemBody>
  <stimulus>
    <h2>Reading Passage</h2>
    <p>Content here...</p>
  </stimulus>

  <choiceInteraction>...</choiceInteraction>
</itemBody>
```

The transformer:
1. Extracts the stimulus content
2. Creates a passage model in `config.models[]`
3. Does **NOT** populate the `passage` property (inline content)

**Result:**
```typescript
{
  id: 'item-123',
  // NO passage property for inline content
  config: {
    models: [
      {
        id: 'passage-...',
        element: '@pie-element/passage',
        passages: [{ title: '', text: '<h2>Reading Passage</h2>...' }]
      },
      { /* question model */ }
    ]
  }
}
```

## Implementation Changes

### Modified Files

#### 1. `src/utils/passage-extraction.ts`

**Change:** Updated `extractObjectPassages()` return type to include `passageId`

```typescript
export function extractObjectPassages(
  itemBody: HTMLElement
): Array<{ model: PassageModel; filePath: string; passageId: string }> {
  // ...

  // Extract passage ID from data-pie-passage-id attribute (if present)
  const passageId = obj.getAttribute('data-pie-passage-id') || reference.id;

  passages.push({
    model: { /* ... */ },
    filePath: reference.filePath,
    passageId, // ← NEW: Passage ID for reference
  });
}
```

#### 2. `src/transformers/multiple-choice.ts`

**Change:** Populate `passage` property when external passages found

```typescript
// After building PIE item...

// Populate passage property if external passage was found
if (objectPassages.length > 0) {
  pieItem.passage = objectPassages[0].passageId;
}
```

#### 3. `src/transformers/extended-response.ts`

**Change:** Same as multiple-choice - populate `passage` property

```typescript
// Populate passage property if external passage was found
if (objectPassages.length > 0) {
  pieItem.passage = objectPassages[0].passageId;
}
```

### New Test Files

#### 1. `tests/integration/passage-extraction.test.ts` (7 tests)

Tests QTI → PIE transformation with various passage configurations:
- External passage with `data-pie-passage-id`
- External passage without attribute (fallback to file path)
- Inline stimulus (no `passage` property)
- Items without passages
- Extended-response items with passages
- Path preservation in passage models

#### 2. `tests/integration/passage-roundtrip.test.ts` (4 tests)

Documents round-trip behavior (PIE → QTI → PIE):
- Passage ID preservation through object references
- BaseId handling in passages
- Inline stimulus behavior (no `passage` property)
- Custom passage IDs

## Test Results

**Total Tests:** 275 passing (added 11 new tests)
- 7 passage extraction tests
- 4 passage round-trip tests

**Coverage:**
- ✅ External passage extraction from `<object>` tags
- ✅ Passage ID extraction from `data-pie-passage-id`
- ✅ Fallback to file path for ID generation
- ✅ Inline stimulus handling (no `passage` property)
- ✅ Multiple-choice item transformation
- ✅ Extended-response item transformation
- ✅ Items without passages

## Round-Trip Compatibility

The implementation ensures proper round-trip transformation:

### Forward: PIE → QTI (pie-to-qti2)

```typescript
// Input: PIE item with external passage
{
  id: 'item-1',
  passage: 'passage-abc',
  config: { models: [/* MC question */] }
}

// Output: QTI with object reference
<object data="passages/passage-abc.xml"
        type="text/html"
        data-pie-passage-id="passage-abc"/>
```

### Reverse: QTI → PIE (qti2-to-pie)

```xml
<!-- Input: QTI with object reference -->
<object data="passages/passage-abc.xml"
        type="text/html"
        data-pie-passage-id="passage-abc"/>

// Output: PIE item with external passage
{
  id: 'item-1',
  passage: 'passage-abc', // ← Restored!
  config: { models: [/* passage placeholder + MC */] }
}
```

**Result:** `passage` property is preserved through the round-trip.

## BaseId Support

External passages can use baseId for stable/public identifiers:

```typescript
// PIE item with baseId in passage
{
  id: 'item-internal',
  baseId: 'item-public-stable',
  passage: 'passage-stable-123',
  // ...
}
```

**pie-to-qti2** generates:
```xml
<assessmentItem identifier="item-public-stable">
  <object data="passages/passage-stable-123.xml"
          data-pie-passage-id="passage-stable-123"/>
</assessmentItem>
```

**qti2-to-pie** restores:
```typescript
{
  id: 'item-public-stable',
  passage: 'passage-stable-123', // ← Preserved
  // ...
}
```

## Limitations and Future Work

### Current Limitations

1. **Placeholder Content Only**: External passages create placeholder models with text like `[External passage: path.xml]`. Full passage content loading requires additional infrastructure.

2. **Single Passage Support**: If an item has multiple external passage references, only the first is used for the `passage` property.

3. **No Content Loading**: The `contentLoader` parameter in `extractObjectPassages()` is not yet implemented.

### Future Enhancements

1. **Content Loading**: Implement `contentLoader` to fetch and populate full passage content from external files during transformation.

2. **Multiple Passages**: Support items with multiple external passage references (array of IDs).

3. **Metadata Extraction**: Extract baseId and externalId from passage file metadata when loading content.

4. **Batch Processing**: Optimize passage loading for batch transformations (load each passage once, reuse across items).

## API Reference

### Updated Function Signatures

```typescript
// passage-extraction.ts
export function extractObjectPassages(
  itemBody: HTMLElement,
  contentLoader?: (filePath: string) => Promise<string> | string
): Array<{
  model: PassageModel;
  filePath: string;
  passageId: string; // NEW: Extracted passage ID
}>;

// transformers
export async function transformMultipleChoice(
  itemElement: HTMLElement,
  itemId: string,
  options?: MultipleChoiceOptions
): Promise<PieItem>; // PieItem may now have `passage` property

export async function transformExtendedResponse(
  itemElement: HTMLElement,
  itemId: string,
  options?: ExtendedResponseOptions
): Promise<PieItem>; // PieItem may now have `passage` property
```

### PIE Item Structure

```typescript
interface PieItem {
  id: string;
  baseId?: string;
  uuid: string;

  // NEW: External passage reference (if item uses external passage)
  passage?: string;

  config: {
    id: string;
    models: Array</* passage models + question models */>;
    elements: Record<string, string>;
  };

  metadata?: {
    searchMetaData?: Record<string, any>;
  };
}
```

## Related Documentation

- [External Passages (PIE → QTI)](../../pie-to-qti2/docs/EXTERNAL-PASSAGES.md) - Forward transformation
- [Phase 2 Summary](../../pie-to-qti2/docs/PHASE2-SUMMARY.md) - Complete Phase 2 implementation
- [BaseId Tests](../../pie-to-qti2/tests/unit/passage-baseid.test.ts) - BaseId support tests

## Contributors

**Phase 2 External Passage Support - QTI → PIE**
Implemented: January 2026
Tests: 275 passing (11 new passage tests)
Files Modified: 3
Files Created: 2
